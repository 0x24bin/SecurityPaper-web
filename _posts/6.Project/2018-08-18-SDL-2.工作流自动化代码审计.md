---
date: 2018-08-16
title: 2.工作流自动化代码审计
categories:
  - 6.Project
description: 工作流自动化代码审计
type: Document
---

作者：Lost Maniac

协作：

最后更新时间：2018年08月27日 14:09

-----

## 简介
---

sonar

## 项目源码

本项目托管在GitHub，地址为：https://github.com/sdlchina/php_code_audit

## 部署方法
---

安装文档基于centos 7.x

### 安装PGsql

打开官网安装文档 `https://www.postgresql.org/download/linux/redhat/`

选择要安装的版本为10版本

安装repo源

`yum install https://download.postgresql.org/pub/repos/yum/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm`

安装客户端

`yum install postgresql10`

安装服务端

`yum install postgresql10-server`

新建数据库存储目录

`mkdir -p /www/pgsql/data`  //递归方式创建pgsql/data目录

授权目录权限

chown -R postgres:postgres  /www/pgsql/

修改开机启动配置文件

`vim /usr/lib/systemd/system/postgresql-10.service`

-----

```conf
[Unit]
Description=PostgreSQL 10 database server
Documentation=https://www.postgresql.org/docs/10/static/
After=syslog.target
After=network.target

[Service]
Type=notify

User=postgres
Group=postgres

# Note: avoid inserting whitespace in these Environment= lines, or you may
# break postgresql-setup.

# Location of database directory
Environment=PGDATA=/www/pgsql/data/

# Where to send early-startup messages from the server (before the logging
# options of postgresql.conf take effect)
# This is normally controlled by the global default set by systemd
# StandardOutput=syslog

# Disable OOM kill on the postmaster
OOMScoreAdjust=-1000
Environment=PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj
Environment=PG_OOM_ADJUST_VALUE=0

ExecStartPre=/usr/pgsql-10/bin/postgresql-10-check-db-dir ${PGDATA}
ExecStart=/usr/pgsql-10/bin/postmaster -D ${PGDATA}
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
KillSignal=SIGINT


# Do not set any timeout value, so that systemd will not kill postmaster
# during crash recovery.
TimeoutSec=0

[Install]
WantedBy=multi-user.target
```

修改初始化脚本

`vim /usr/pgsql-10/bin/postgresql-10-setup`

-----

```conf
# Log file for initdb
PGLOG=/www/pgsql/log/initdb.log

```

-----

对PGsql进行初始化

`/usr/pgsql-10/bin/postgresql-10-setup initdb`

检查目录`/www/pgsql/data`目录下有文件表示初始化成功

开启pgsql服务

`systemctl start postgresql-10.service`

检查pgsql服务

`systemctl status postgresql-10.service`

显示

```linux
● postgresql-10.service - PostgreSQL 10 database server
   Loaded: loaded (/usr/lib/systemd/system/postgresql-10.service; disabled; vendor preset: disabled)
   Active: active (running) since Mon 2018-09-10 11:35:21 CST; 1h 5min ago
     Docs: https://www.postgresql.org/docs/10/static/
  Process: 17986 ExecStartPre=/usr/pgsql-10/bin/postgresql-10-check-db-dir ${PGDATA} (code=exited, status=0/SUCCESS)
 Main PID: 17993 (postmaster)
   CGroup: /system.slice/postgresql-10.service
           ├─17993 /usr/pgsql-10/bin/postmaster -D /www/pgsql/data/
           ├─17994 postgres: logger process
           ├─17996 postgres: checkpointer process
           ├─17997 postgres: writer process
           ├─17998 postgres: wal writer process
           ├─17999 postgres: autovacuum launcher process
           ├─18000 postgres: stats collector process
           └─18001 postgres: bgworker: logical replication launcher
```

表示服务启动成功

由于pgsql默认既是监听127.0.0.1，所以不加密码也OK

切换到postgres用户

`su - postgres`

连接到数据库

`psql`

创建数据库

`postgres=#  CREATE DATABASE sonar;`

创建用户

`CREATE USER sonar WITH PASSWORD 'xxxxx';`

创建授权

`GRANT ALL PRIVILEGES ON DATABASE sonar to sonar;`

修改配置文件

`vim /www/pgsql/data/pg_hba.conf`

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
# Allow replication connections from localhost, by a user with the
# replication privilege.
#local   replication     all                                     peer
#host    replication     all             127.0.0.1/32            ident
#host    replication     all             ::1/128                 ident
host    all             all             0.0.0.0/0       md5
```

重新载入配置文件

`systemctl reload postgresql-10.service`



### 安装sonar

官方下载地址：`https://www.sonarqube.org/downloads/`

本次选择最新版本7.3版本

新建安装目录

`mkdir /www/sonar`

由于sonar不能使用root启动，所以我们需要新建用户

新建用户
`useradd sonar`

切换到安装目录

`cd /www/sonar`

下载sonar

`wget https://sonarsource.bintray.com/Distribution/sonarqube/sonarqube-7.3.zip`

解压sonar

`unzip sonarqube-7.3.zip`

> 如果提示没有unzip命令请执行`yum install unzip`安装命令后，再次执行解压

切换到sonar解压后目录

`cd sonarqube-7.3`

移动所有文件到上级目录&返回上级目录

`mv * .. && cd ..`

删除无用文件

`rm -rf sonarqube-7.3.zip sonarqube-7.3/`

修改目录所属权限

`chown -R sonar:sonar /www/sonar/`

切换用户

`su - sonar`

切换目录

`cd /www/sonar/`

配置文件

`vim /www/sonar/conf/sonar.properties`

```conf
sonar.jdbc.username=sonar
sonar.jdbc.password=xxxxx
sonar.jdbc.url=jdbc:postgresql://localhost/sonar
sonar.web.javaOpts=-Xmx8120m -Xms128m -XX:+HeapDumpOnOutOfMemoryError
sonar.web.host=127.0.0.1
sonar.web.port=9000
sonar.search.javaOpts=-Xms512m -Xmx4096m -XX:+HeapDumpOnOutOfMemoryError
sonar.telemetry.enable=false
```

启动服务

`/www/sonar/bin/linux-x86-64/sonar.sh start`

测试是否能访问

```curl http://127.0.0.1:9000

### 安装NGINX

yum install nginx

增加配置文件

`/etc/nginx/conf.d/sonar.conf`

```nginx
server {
        server_name sonar.xxx.com;
        listen 80;
        location / {
                proxy_pass http://127.0.0.1:9000;
        }
}
```

